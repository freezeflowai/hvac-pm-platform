import React, { useMemo, useState } from "react";

type CatalogItemType = "product" | "service";

export interface CatalogItem {
  id: string;
  type: CatalogItemType;
  name: string;
  description?: string;
  defaultCost: number;
  defaultPrice: number;
  taxable: boolean;
}

type LineItemKind = "part" | "service" | "other";

export interface JobLineItem {
  id: string;
  jobId: string;
  catalogItemId?: string;
  kind: LineItemKind;
  name: string;
  description?: string;
  quantity: number;
  unitCost: number;
  unitPrice: number;
}

interface PartsBillingCardProps {
  jobId: string;
  initialItems: JobLineItem[];
  catalogItems: CatalogItem[];
  /** Optional callback – call your API here */
  onSave?: (items: JobLineItem[], catalog: CatalogItem[]) => Promise<void> | void;
}

/**
 * Top-level card shown on the Job page.
 * - Shows profitability summary
 * - Lists line items
 * - Allows adding/editing/removing items
 * - Has a Save button at the bottom
 */
const PartsBillingCard: React.FC<PartsBillingCardProps> = ({
  jobId,
  initialItems,
  catalogItems,
  onSave,
}) => {
  const [items, setItems] = useState<JobLineItem[]>(() =>
    initialItems.map((i) => ({ ...i }))
  );
  const [catalog, setCatalog] = useState<CatalogItem[]>(() => [...catalogItems]);
  const [editingRowId, setEditingRowId] = useState<string | null>(null);
  const [hasChanges, setHasChanges] = useState(false);
  const [isSaving, setIsSaving] = useState(false);

  const { totalPrice, totalCost, profit, margin } = useMemo(() => {
    const totalPrice = items.reduce(
      (sum, i) => sum + i.unitPrice * i.quantity,
      0
    );
    const totalCost = items.reduce(
      (sum, i) => sum + i.unitCost * i.quantity,
      0
    );
    const profit = totalPrice - totalCost;
    const margin = totalPrice > 0 ? (profit / totalPrice) * 100 : 0;

    return { totalPrice, totalCost, profit, margin };
  }, [items]);

  const handleAddLineItem = () => {
    const id = `li_${Date.now()}_${Math.random().toString(36).slice(2, 7)}`;
    const newItem: JobLineItem = {
      id,
      jobId,
      kind: "part",
      name: "",
      description: "",
      quantity: 1,
      unitCost: 0,
      unitPrice: 0,
    };
    setItems((prev) => [...prev, newItem]);
    setEditingRowId(id);
    setHasChanges(true);
  };

  const handleRowChange = (id: string, patch: Partial<JobLineItem>) => {
    setItems((prev) =>
      prev.map((item) => (item.id === id ? { ...item, ...patch } : item))
    );
    setHasChanges(true);
  };

  const handleRowDelete = (id: string) => {
    setItems((prev) => prev.filter((i) => i.id !== id));
    if (editingRowId === id) setEditingRowId(null);
    setHasChanges(true);
  };

  const handleCreateCatalogItem = (partial: {
    name: string;
    description?: string;
    defaultCost: number;
    defaultPrice: number;
    type: CatalogItemType;
  }): CatalogItem => {
    const newItem: CatalogItem = {
      id: `cat_${Date.now()}_${Math.random().toString(36).slice(2, 7)}`,
      taxable: true,
      ...partial,
    };
    setCatalog((prev) => [...prev, newItem]);
    return newItem;
  };

  const handleSave = async () => {
    try {
      setIsSaving(true);
      if (onSave) {
        await onSave(items, catalog);
      } else {
        // TODO: replace this with your real API call.
        console.log("Saving line items", { jobId, items, catalog });
      }
      setHasChanges(false);
    } finally {
      setIsSaving(false);
    }
  };

  const [productModalState, setProductModalState] = useState<{
    open: boolean;
    seedName: string;
    lineItemId: string | null;
  }>({
    open: false,
    seedName: "",
    lineItemId: null,
  });

  const openAddProductModal = (lineItemId: string, name: string) => {
    setProductModalState({ open: true, seedName: name, lineItemId });
  };

  const closeAddProductModal = () => {
    setProductModalState({ open: false, seedName: "", lineItemId: null });
  };

  const handleProductCreatedForLine = (catalogItem: CatalogItem) => {
    if (!productModalState.lineItemId) return;
    const lineId = productModalState.lineItemId;

    handleRowChange(lineId, {
      catalogItemId: catalogItem.id,
      name: catalogItem.name,
      description: catalogItem.description,
      unitCost: catalogItem.defaultCost,
      unitPrice: catalogItem.defaultPrice,
    });

    closeAddProductModal();
  };

  return (
    <section className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
      {/* Header / title */}
      <div className="px-5 py-4 border-b border-gray-200 flex items-center justify-between">
        <div>
          <h2 className="text-sm font-semibold text-gray-900">
            Parts &amp; Billing
          </h2>
          <p className="mt-1 text-xs text-gray-500">
            Add parts and services for this job. Changes are saved when you
            click <span className="font-medium text-gray-700">Save</span>.
          </p>
        </div>

        <div className="flex items-center gap-6 text-xs text-gray-700">
          <div className="text-right">
            <div className="text-[11px] uppercase tracking-wide text-gray-500">
              Total Price
            </div>
            <div className="font-semibold">
              {formatCurrency(totalPrice)}
            </div>
          </div>
          <div className="text-right">
            <div className="text-[11px] uppercase tracking-wide text-gray-500">
              Total Cost
            </div>
            <div className="font-semibold">
              {formatCurrency(totalCost)}
            </div>
          </div>
          <div className="text-right">
            <div className="text-[11px] uppercase tracking-wide text-gray-500">
              Profit Margin
            </div>
            <div className="font-semibold">
              {formatCurrency(profit)}{" "}
              <span className="text-[11px] text-gray-500">
                • {margin.toFixed(1)}%
              </span>
            </div>
          </div>
        </div>
      </div>

      {/* Table */}
      <div className="px-5 pb-4 pt-2">
        <div className="overflow-x-auto">
          <table className="min-w-full text-xs">
            <thead className="border-b border-gray-200 text-[11px] uppercase tracking-wide text-gray-500">
              <tr>
                <th className="py-2 pr-3 text-left font-medium">
                  Product / Service
                </th>
                <th className="py-2 px-3 text-right font-medium w-20">Qty</th>
                <th className="py-2 px-3 text-right font-medium w-28">
                  Unit Cost
                </th>
                <th className="py-2 px-3 text-right font-medium w-28">
                  Unit Price
                </th>
                <th className="py-2 pl-3 text-right font-medium w-28">
                  Total
                </th>
              </tr>
            </thead>
            <tbody>
              {items.length === 0 && (
                <tr>
                  <td
                    colSpan={5}
                    className="py-6 text-center text-xs text-gray-500"
                  >
                    No line items yet. Click{" "}
                    <span className="font-medium text-gray-700">
                      Add Line Item
                    </span>{" "}
                    to get started.
                  </td>
                </tr>
              )}

              {items.map((item) => (
                <LineItemRow
                  key={item.id}
                  item={item}
                  catalog={catalog}
                  isEditing={editingRowId === item.id}
                  onEnterEdit={() => setEditingRowId(item.id)}
                  onChange={(patch) => handleRowChange(item.id, patch)}
                  onDelete={() => handleRowDelete(item.id)}
                  onRequestAddProduct={(name) =>
                    openAddProductModal(item.id, name)
                  }
                />
              ))}
            </tbody>
          </table>
        </div>

        <div className="mt-4 flex items-center justify-between">
          <button
            type="button"
            onClick={handleAddLineItem}
            className="inline-flex items-center rounded-md border border-gray-300 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50"
          >
            +
            <span className="ml-1">Add Line Item</span>
          </button>

          {hasChanges && (
            <span className="text-[11px] text-gray-500">
              Unsaved changes
            </span>
          )}
        </div>
      </div>

      {/* Footer / Save area */}
      <div className="border-t border-gray-200 bg-gray-50 px-5 py-3 flex justify-end">
        <button
          type="button"
          onClick={handleSave}
          disabled={!hasChanges || isSaving}
          className={`inline-flex items-center rounded-md px-4 py-1.5 text-xs font-medium shadow-sm ${
            !hasChanges || isSaving
              ? "bg-gray-300 text-gray-600 cursor-not-allowed"
              : "bg-blue-600 text-white hover:bg-blue-700"
          }`}
        >
          {isSaving ? "Saving…" : "Save changes"}
        </button>
      </div>

      {/* Add product modal */}
      <AddProductModal
        open={productModalState.open}
        initialName={productModalState.seedName}
        onClose={closeAddProductModal}
        onSave={(partial) => {
          const created = handleCreateCatalogItem(partial);
          handleProductCreatedForLine(created);
        }}
      />
    </section>
  );
};

/* ---------- Line item row ---------- */

interface LineItemRowProps {
  item: JobLineItem;
  catalog: CatalogItem[];
  isEditing: boolean;
  onEnterEdit: () => void;
  onChange: (patch: Partial<JobLineItem>) => void;
  onDelete: () => void;
  onRequestAddProduct: (name: string) => void;
}

/**
 * Renders a single line item in read mode or edit mode.
 * - Click the row to enter edit mode.
 */
const LineItemRow: React.FC<LineItemRowProps> = ({
  item,
  catalog,
  isEditing,
  onEnterEdit,
  onChange,
  onDelete,
  onRequestAddProduct,
}) => {
  const [query, setQuery] = useState(item.name ?? "");
  const [showDropdown, setShowDropdown] = useState(false);

  const suggestions = useMemo(() => {
    if (!query.trim()) return catalog.slice(0, 8);
    const lower = query.toLowerCase();
    return catalog
      .filter((c) => c.name.toLowerCase().includes(lower))
      .slice(0, 8);
  }, [catalog, query]);

  const handleSelectCatalogItem = (c: CatalogItem) => {
    setQuery(c.name);
    onChange({
      catalogItemId: c.id,
      name: c.name,
      description: c.description,
      unitCost: c.defaultCost,
      unitPrice: c.defaultPrice,
    });
    setShowDropdown(false);
  };

  const lineTotal = item.unitPrice * item.quantity;

  if (!isEditing) {
    return (
      <tr
        className="border-b border-gray-100 hover:bg-gray-50 cursor-pointer"
        onClick={onEnterEdit}
      >
        <td className="py-3 pr-3 align-top">
          <div className="text-xs font-medium text-gray-900">
            {item.name || <span className="italic text-gray-400">No product</span>}
          </div>
          {item.description && (
            <div className="mt-0.5 text-[11px] text-gray-500">
              {item.description}
            </div>
          )}
        </td>
        <td className="py-3 px-3 text-right align-top text-xs text-gray-700">
          {item.quantity}
        </td>
        <td className="py-3 px-3 text-right align-top text-xs text-gray-700">
          {formatCurrency(item.unitCost)}
        </td>
        <td className="py-3 px-3 text-right align-top text-xs text-gray-700">
          {formatCurrency(item.unitPrice)}
        </td>
        <td className="py-3 pl-3 pr-1 text-right align-top text-xs font-semibold text-gray-900">
          {formatCurrency(lineTotal)}
        </td>
      </tr>
    );
  }

  return (
    <tr className="border-b border-gray-100 bg-blue-50/40">
      <td className="py-2.5 pr-3 align-top">
        <div className="relative">
          <input
            className="w-full rounded-md border border-blue-300 bg-white px-2.5 py-1.5 text-xs text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
            placeholder="Search product / service…"
            value={query}
            onChange={(e) => {
              setQuery(e.target.value);
              onChange({ name: e.target.value });
              setShowDropdown(true);
            }}
            onFocus={() => setShowDropdown(true)}
            onBlur={() => {
              // Slight delay to allow click on dropdown
              setTimeout(() => setShowDropdown(false), 150);
            }}
          />

          {showDropdown && (
            <div className="absolute z-20 mt-1 max-h-48 w-full overflow-auto rounded-md border border-gray-200 bg-white shadow-lg">
              {suggestions.map((c) => (
                <button
                  key={c.id}
                  type="button"
                  onMouseDown={(e) => e.preventDefault()}
                  onClick={() => handleSelectCatalogItem(c)}
                  className="flex w-full flex-col items-start px-2.5 py-1.5 text-left hover:bg-gray-50"
                >
                  <span className="text-xs text-gray-900">{c.name}</span>
                  {c.description && (
                    <span className="mt-0.5 text-[11px] text-gray-500 line-clamp-1">
                      {c.description}
                    </span>
                  )}
                </button>
              ))}

              <div className="border-t border-gray-100" />

              <button
                type="button"
                onMouseDown={(e) => e.preventDefault()}
                onClick={() => onRequestAddProduct(query)}
                className="flex w-full items-center px-2.5 py-1.5 text-left text-xs text-blue-600 hover:bg-blue-50"
              >
                + Add “{query || "new item"}” as product
              </button>
            </div>
          )}
        </div>

        <textarea
          className="mt-2 w-full rounded-md border border-gray-200 bg-white px-2.5 py-1 text-[11px] text-gray-700 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
          rows={2}
          placeholder="Optional description…"
          value={item.description ?? ""}
          onChange={(e) => onChange({ description: e.target.value })}
        />

        <button
          type="button"
          onClick={onDelete}
          className="mt-1.5 text-[11px] text-red-500 hover:text-red-600"
        >
          Remove line
        </button>
      </td>

      <td className="py-2.5 px-3 align-top">
        <input
          type="number"
          min={0}
          className="w-full rounded-md border border-gray-200 bg-white px-2 py-1.5 text-xs text-right text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
          value={item.quantity}
          onChange={(e) =>
            onChange({ quantity: Number(e.target.value) || 0 })
          }
        />
      </td>

      <td className="py-2.5 px-3 align-top">
        <input
          type="number"
          min={0}
          step="0.01"
          className="w-full rounded-md border border-gray-200 bg-white px-2 py-1.5 text-xs text-right text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
          value={item.unitCost}
          onChange={(e) =>
            onChange({ unitCost: Number(e.target.value) || 0 })
          }
        />
      </td>

      <td className="py-2.5 px-3 align-top">
        <input
          type="number"
          min={0}
          step="0.01"
          className="w-full rounded-md border border-gray-200 bg-white px-2 py-1.5 text-xs text-right text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
          value={item.unitPrice}
          onChange={(e) =>
            onChange({ unitPrice: Number(e.target.value) || 0 })
          }
        />
      </td>

      <td className="py-2.5 pl-3 pr-1 align-top text-right text-xs font-semibold text-gray-900">
        {formatCurrency(lineTotal)}
      </td>
    </tr>
  );
};

/* ---------- Add Product modal ---------- */

interface AddProductModalProps {
  open: boolean;
  initialName: string;
  onClose: () => void;
  onSave: (partial: {
    name: string;
    description?: string;
    defaultCost: number;
    defaultPrice: number;
    type: CatalogItemType;
  }) => void;
}

const AddProductModal: React.FC<AddProductModalProps> = ({
  open,
  initialName,
  onClose,
  onSave,
}) => {
  const [name, setName] = useState(initialName);
  const [description, setDescription] = useState("");
  const [type, setType] = useState<CatalogItemType>("product");
  const [cost, setCost] = useState(0);
  const [price, setPrice] = useState(0);

  React.useEffect(() => {
    if (open) {
      setName(initialName);
    }
  }, [open, initialName]);

  if (!open) return null;

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (!name.trim()) return;
    onSave({
      name: name.trim(),
      description: description.trim() || undefined,
      defaultCost: cost,
      defaultPrice: price,
      type,
    });
  };

  return (
    <div className="fixed inset-0 z-40 flex items-center justify-center bg-black/30">
      <div className="w-full max-w-md rounded-xl bg-white shadow-lg">
        <form onSubmit={handleSubmit}>
          <div className="border-b border-gray-200 px-4 py-3">
            <h3 className="text-sm font-semibold text-gray-900">
              Add new product
            </h3>
            <p className="mt-1 text-[11px] text-gray-500">
              This item will be added to your Products &amp; Services and
              linked to this line item.
            </p>
          </div>

          <div className="px-4 py-3 space-y-3 text-xs">
            <div>
              <label className="mb-1 block text-[11px] font-medium text-gray-700">
                Name
              </label>
              <input
                className="w-full rounded-md border border-gray-300 px-2 py-1.5 text-xs text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                value={name}
                onChange={(e) => setName(e.target.value)}
                autoFocus
              />
            </div>

            <div>
              <label className="mb-1 block text-[11px] font-medium text-gray-700">
                Description (optional)
              </label>
              <textarea
                rows={3}
                className="w-full rounded-md border border-gray-300 px-2 py-1.5 text-xs text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                value={description}
                onChange={(e) => setDescription(e.target.value)}
              />
            </div>

            <div className="flex gap-3">
              <div className="flex-1">
                <label className="mb-1 block text-[11px] font-medium text-gray-700">
                  Type
                </label>
                <select
                  className="w-full rounded-md border border-gray-300 px-2 py-1.5 text-xs text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                  value={type}
                  onChange={(e) =>
                    setType(e.target.value as CatalogItemType)
                  }
                >
                  <option value="product">Product</option>
                  <option value="service">Service</option>
                </select>
              </div>

              <div className="flex-1">
                <label className="mb-1 block text-[11px] font-medium text-gray-700">
                  Unit cost
                </label>
                <input
                  type="number"
                  min={0}
                  step="0.01"
                  className="w-full rounded-md border border-gray-300 px-2 py-1.5 text-xs text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                  value={cost}
                  onChange={(e) => setCost(Number(e.target.value) || 0)}
                />
              </div>

              <div className="flex-1">
                <label className="mb-1 block text-[11px] font-medium text-gray-700">
                  Unit price
                </label>
                <input
                  type="number"
                  min={0}
                  step="0.01"
                  className="w-full rounded-md border border-gray-300 px-2 py-1.5 text-xs text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                  value={price}
                  onChange={(e) => setPrice(Number(e.target.value) || 0)}
                />
              </div>
            </div>
          </div>

          <div className="flex justify-end gap-2 border-t border-gray-200 bg-gray-50 px-4 py-3">
            <button
              type="button"
              onClick={onClose}
              className="rounded-md border border-gray-300 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 hover:bg-gray-50"
            >
              Cancel
            </button>
            <button
              type="submit"
              className="rounded-md bg-blue-600 px-3 py-1.5 text-xs font-medium text-white shadow-sm hover:bg-blue-700"
            >
              Save product
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

/* ---------- helpers ---------- */

function formatCurrency(value: number): string {
  return new Intl.NumberFormat("en-CA", {
    style: "currency",
    currency: "CAD",
    minimumFractionDigits: 2,
  }).format(value || 0);
}

export default PartsBillingCard;
